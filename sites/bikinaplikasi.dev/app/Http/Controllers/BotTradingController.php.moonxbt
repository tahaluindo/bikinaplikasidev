<?php

namespace App\Http\Controllers;

use GuzzleHttp\Client;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\Http;
use phpseclib3\Net\SSH2;

class BotTradingController extends Controller
{

    public function test()
    {
        $access = 'd59cb98f-060f-4d91-ac17-b9eae8ce436c';
        $secret = 'a68f2d6e-523a-4750-841f-a1523562415c';
        $host = 'https://api.moonxbt.com';
        $hostWithoutProtocol = 'api.moonxbt.com';
        $uri = '/v1/orders/history/get';
        $time = now()->utc()->format('Y-m-d\Th:i:s');
        $method = 'POST';
        $query = [
            'AccessKey' => $access,
            'SignatureMethod' => 'HmacSHA256',
            'SignatureVersion' => '1',
            'Timestamp' => $time,
        ];
        $signText = collect($query)->map(function ($v, $k) {
            return "{$k}=" . urlencode($v);
        })->join('&');
        $preSign = "{$method}\n{$hostWithoutProtocol}\n{$uri}\n{$signText}";
        $signature = base64_encode(hash_hmac('sha256', ($preSign), $secret, true));
        $query['Signature'] = (($signature));
        $res = Http::get($host.$uri, $query);
        dd($body = json_decode($res->body()));
    }

    public function client()
    {

        return new Client();
    }

    // done
    public function checkTokenExpired()
    {
        // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, 'https://www.moonxbt.com/account/app/userdetails/islogin');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, "token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g");

        $headers = array();
        $headers[] = 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0';
        $headers[] = 'Accept: application/json, text/plain, */*';
        $headers[] = 'Accept-Language: en-US,en;q=0.5';
        $headers[] = 'Accept-Encoding: gzip, deflate, br';
        $headers[] = 'Content-Type: application/x-www-form-urlencoded';
        $headers[] = 'Origin: https://www.moonxbt.com';
        $headers[] = 'Connection: keep-alive';
        $headers[] = 'Referer: https://www.moonxbt.com/trade/SANDUSDT';
        $headers[] = 'Cookie: Hm_lvt_fbbbc9768e53aa2ef634d6949813475c=1664747580; _ga_SFLCT88EKX=GS1.1.1664771125.2.0.1664771125.0.0.0; _ga=GA1.1.1362986683.1664747594; __zlcmid=1CFlGsea16a9RUR; lang=id; uid=rB8KBGOPCr8ydSoAF6dRAg==; __cfruid=3d7e2c576c499a8ea3d5ec979d5e6ba2713eadc2-1670335882; vueSymbol=sandusdt; lastLoginAccount=ramdanriawan3@gmail.com; mytoken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g; isMarketMaker=200301; userType=1%\"2C1;';
        $headers[] = 'Sec-Fetch-Dest: empty';
        $headers[] = 'Sec-Fetch-Mode: cors';
        $headers[] = 'Sec-Fetch-Site: same-origin';
        $headers[] = 'Te: trailers';
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        $result = curl_exec($ch);
        if (curl_errno($ch)) {
            echo 'Error:' . curl_error($ch);
        }
        curl_close($ch);

        header('content-type: application/json');

        die($result);
    }

    public function position(Request $request)
    {
        $this->sendTelegramMessage2("logika membuka posisi terdeteksi (server)");

        start:

        file_put_contents("logika_membuka_posisi_terdeteksi", json_encode($request->toArray()));

        try {
            Artisan::call("view:clear");

            $filename = "{$request->logic_name}_" . preg_replace("/\/|\:/", "_", $request->timeToOpenPosition);

            if (in_array($request->logicName, ["isLogic1", "psr_sell_macd_blue_bb_between_macd_blue", "psr_buy_macd_red_bb_between_macd_red"])) {
                if (file_exists($filename)) {

                    goto end;
                }

                file_put_contents($filename, '-');
                $this->openPosition($request);
            } else {

                if ($request->logicName == "psr_sell_macd_red_bb_between_macd_red") {
                    $filename_time_before1 = "psr_buy_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "psr_sell_macd_red_bb_between_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "psr_buy_macd_blue_bb_between_macd_blue") {
                    $filename_time_before1 = "psr_sell_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before2 = "bb_between_macd_cross_to_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "psr_buy_macd_blue_bb_between_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                    if (file_exists($filename_time_before2)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before2)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "psr_buy_macd_red") {
                    $filename_time_before1 = "bb_between_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before2 = "bb_between_macd_cross_to_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "psr_buy_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1) || file_exists($filename_time_before2)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "psr_buy_macd_cross") {
                    $filename_time_before1 = "bb_between_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "psr_buy_macd_cross_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "psr_sell_macd_cross_bb_between_macd_cross_to_blue") {
                    $filename_time_detect = "psr_sell_macd_cross_bb_between_macd_cross_to_blue_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (!file_exists($filename_time_detect)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "psr_buy_macd_blue") {
                    $filename_time_before1 = "bb_between_macd_cross_to_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before2 = "bb_between_macd_cross_to_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before3 = "psr_sell_macd_cross_bb_between_macd_cross_to_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);

                    $filename_time_detect = "psr_buy_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                    if (file_exists($filename_time_before2)) {
                        $request->request->add(['order_type' => 0]);
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before2)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                    if (file_exists($filename_time_before3)) {
                        $request->request->add(['order_type' => 0]);
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before2)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                } elseif ($request->logicName == "psr_sell_macd_blue") {
                    $filename_time_before1 = "bb_between_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "psr_sell_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "psr_sell_macd_cross") {
                    $filename_time_before1 = "bb_between_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "psr_sell_macd_cross_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "psr_sell_macd_red") {
                    $filename_time_before1 = "bb_between_macd_cross_to_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "psr_sell_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "bb_between_macd_blue") {
                    $filename_time_before1 = "psr_buy_macd_cross_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before2 = "psr_sell_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "bb_between_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);

                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                    // kalo sell
                    if (file_exists($filename_time_before2)) {

                        $request->request->add(['order_type' => 1]);

                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, '-');
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, '-');
                    }

                } elseif ($request->logicName == "bb_between_macd_cross_to_blue") {
                    $filename_time_before1 = "psr_buy_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before2 = "psr_buy_macd_cross_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "bb_between_macd_cross_to_blue_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1) || file_exists($filename_time_before2)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                } elseif ($request->logicName == "bb_between_macd_cross_to_red") {
                    $filename_time_before1 = "psr_sell_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before2 = "psr_sell_macd_blue_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before3 = "psr_sell_macd_cross_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "bb_between_macd_cross_to_red_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1) || file_exists($filename_time_before2) || file_exists($filename_time_before3)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }


                    // logic tambahan
                    if (file_exists($filename_time_before2)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    }
                } elseif ($request->logicName == "bb_between_macd_red") {
                    $filename_time_before1 = "psr_sell_macd_cross_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_before2 = "psr_buy_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeBefore);
                    $filename_time_detect = "bb_between_macd_red_" . preg_replace("/\/|\:/", "_", $request->timeDetect);

                    if (file_exists($filename_time_before1)) {
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before1)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                    if (file_exists($filename_time_before2)) {
                        $request->request->add(['order_type' => 0]);
                        $this->openPosition($request);
                        file_put_contents($filename_time_detect, $request->order_type);
                    } elseif (!file_exists($filename_time_before2)) {
                        file_put_contents($filename_time_detect, $request->order_type);
                    }

                }
            }

            end:
            Artisan::call("view:clear");
            echo "<script>window.close();</script>";
        } catch (\Throwable $t) {
            file_put_contents("error_" . time(), "Error : " . now()->toDateTimeString() . " " . $t->getMessage());

            $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=gagal open position&lang=en-GB-Standard-B&rpt=2", [

            ]);

            // goto start;
        }

    }

    public function openPosition(Request $request)
    {
        start:
        file_put_contents("membuka_posisi_dimulai", json_encode($request->toArray()));

        try {
            // untuk membuka posisi
            // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://www.moonxbt.com/cfd/app/holding/create');
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_POSTFIELDS, "type=1&symbol=sandusdt&leverage=10&startBond=79.32&direction=$request->order_type&targetProfitRatio=57.00&stopLossRatio=12.00&deviceType=Web");

            $headers = array();
            $headers[] = 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0';
            $headers[] = 'Accept: application/json, text/plain, */*';
            $headers[] = 'Accept-Language: id';
            $headers[] = 'Content-Type: application/x-www-form-urlencoded';
            $headers[] = 'Origin: https://www.moonxbt.com';
            $headers[] = 'Connection: keep-alive';
            $headers[] = 'Referer: https://www.moonxbt.com/trade/SANDUSDT';
            $headers[] = 'Cookie: Hm_lvt_fbbbc9768e53aa2ef634d6949813475c=1664747580; _ga_SFLCT88EKX=GS1.1.1664771125.2.0.1664771125.0.0.0; _ga=GA1.1.1362986683.1664747594; __zlcmid=1CFlGsea16a9RUR; uid=rB8LJ2OMN5ZJsVvM5zsZAg==; __cfruid=446486d3c416598e3fe2055b7fda3e2dbf24cb59-1670152654; lang=id; vueSymbol=sandusdt; lastLoginAccount=ramdanriawan3@gmail.com; mytoken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g; isMarketMaker=200301; userType=1%\"2C1;';
            $headers[] = 'Sec-Fetch-Dest: empty';
            $headers[] = 'Sec-Fetch-Mode: cors';
            $headers[] = 'Sec-Fetch-Site: same-origin';
            $headers[] = 'Te: trailers';
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            $json = curl_exec($ch);

            $result = json_decode($json);

            if (curl_errno($ch)) {
                echo 'Error:' . curl_error($ch);
            }
            curl_close($ch);

            $requestData = json_encode($request->all());

            file_put_contents("akan_membuka_posisi", $json);
            if ($result->code === 0) {
                $message = "posisi untuk pair {$request->get('pair')} telah berhasil dibuka";
                $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=$message&lang=en-GB-Standard-B&rpt={$request->get('numOfTelegramCallNotice')}", [

                ]);

                $this->sendTelegramMessage2($message);
                file_put_contents("posisi_berhasil_dibuka", "");
            } elseif ($result->code != 0) {
                $message = "posisi untuk pair {$request->get('pair')} gagal dibuka";

                $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=$message&lang=en-GB-Standard-B&rpt={$request->get('numOfTelegramCallNotice')}", [

                ]);

                $this->sendTelegramMessage2($message);

                file_put_contents("gagal_membuka_posisi", $json);

                // goto start;
            } else {
                file_put_contents("gagal_membuka_posisi", $json);
                $this->sendTelegramMessage2("gagal_membuka_posisi");
                // goto start;
            }
        } catch (\Throwable $t) {
            file_put_contents("gagal_membuka_posisi", $t->getMessage());

            $this->sendTelegramMessage2("gagal_membuka_posisi");

            // goto start;
        }
    }

    public function setBep()
    {
        set_time_limit(0);

        start:

        try {
            $orders = $this->getOrders()->holdingList;

        } catch (\Throwable $t) {
            return "Terjadi kesalahan saat ambil orders: {$t->getMessage()}";
        }

        try {
            foreach ($orders as $order) {
                $order2 = json_encode($order);
                $fileNameSetBep = "has_set_bep_" . $order->code;
                $fileNameHasAddPosition = "has_add_position_" . $order->code;
                $percentProfit = abs(($order->targetProfit / $order->strikePrice * 100 - 100) * 10);

                // posisi long
                if ($percentProfit >= 56 && $order->settlement > ($order->strikePrice * 1.0170) && $order->direction === 0 && !file_exists($fileNameSetBep) && !file_exists($fileNameHasAddPosition)) {
                    file_put_contents("set_bep_dimulai_posisi_long1", $order2);
                    if (file_put_contents($fileNameSetBep, "-") !== false) {
                        $this->setBepBot($order->code, $order->strikePrice, 0, 57.00, 3.00, $order->code);

                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Berhasil set bep&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    } else {
                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Gagal set bep (membuat file)&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    }
                }

                if ($percentProfit >= 56 && $order->settlement > ($order->strikePrice * 1.0240) && $order->direction === 0 && !file_exists($fileNameHasAddPosition)) {
                    file_put_contents("set_bep_dimulai_posisi_long2", $order2);
                    $addPosition = ($order->strikePrice * 1.0260);

                    if (file_put_contents($fileNameHasAddPosition, "-") !== false) {
                        $this->addPosition($order->code, $addPosition, 10, 79.32, $order->direction, 28.00, 10.00, "sandusdt", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g");
                        $this->setBepBot($order->code, 0, 0, 57.00, 16.00, $order->code);

                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Berhasil menambah posisi bep&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    } else {
                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Gagal menambah posisi (membuat file)&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    }
                }

                // posisi short
                if ($percentProfit >= 56 && $order->settlement < ($order->strikePrice * 0.9830) && $order->direction === 1 && !file_exists($fileNameSetBep) && !file_exists($fileNameHasAddPosition)) {
                    file_put_contents("set_bep_dimulai_posisi_short1", $order2);
                    if (file_put_contents($fileNameSetBep, "-") !== false) {
                        $this->setBepBot($order->code, $order->strikePrice, 0, 57.00, 3.00, $order->code);

                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Berhasil set bep&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    } else {
                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Gagal set bep (membuat file)&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    }
                }

                if ($percentProfit >= 56 && $order->settlement < ($order->strikePrice * 0.9760) && $order->direction === 1 && !file_exists($fileNameHasAddPosition)) {
                    file_put_contents("set_bep_dimulai_short_2", $order2);
                    $addPosition = ($order->strikePrice * 0.9740);

                    if (file_put_contents($fileNameHasAddPosition, "-") !== false) {
                        $this->addPosition($order->code, $addPosition, 10, 79.32, $order->direction, 28.00, 10.00, "sandusdt", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g");
                        $this->setBepBot($order->code, 0, 0, 57.00, 16.00, $order->code);

                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Berhasil menambah posisi bep&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    } else {
                        $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=Gagal menambah posisi bep (membuat file)&lang=en-GB-Standard-B&rpt=2", [

                        ]);
                    }
                }
            }

            return "Semuanya sudah di cek";
        } catch (\Throwable $t) {
            file_put_contents("error_set_bep_" . time(), "Error : " . now()->toDateTimeString() . " " . $t->getMessage());

            $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=gagal set BEP&lang=en-GB-Standard-B&rpt=2", [

            ]);

            // goto start;
        }
    }

    public function setBepBot($order_id, $stop_loss_price, $stop_profit_price, $stop_profit_rate, $stop_loss_rate, $id)
    {
        // untuk mengganti stoploss
        // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, 'https://www.moonxbt.com/cfd/app/holding/changeTargetProfitAndStopLoss');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, "token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g&code=$order_id&targetProfitRatio=$stop_profit_rate&stopLossRatio=$stop_loss_rate");

        $headers = array();
        $headers[] = 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0';
        $headers[] = 'Accept: application/json, text/plain, */*';
        $headers[] = 'Accept-Language: id';
        $headers[] = 'Content-Type: application/x-www-form-urlencoded';
        $headers[] = 'Origin: https://www.moonxbt.com';
        $headers[] = 'Connection: keep-alive';
        $headers[] = 'Referer: https://www.moonxbt.com/trade/SANDUSDT';
        $headers[] = 'Cookie: Hm_lvt_fbbbc9768e53aa2ef634d6949813475c=1664747580; _ga_SFLCT88EKX=GS1.1.1664771125.2.0.1664771125.0.0.0; _ga=GA1.1.1362986683.1664747594; __zlcmid=1CFlGsea16a9RUR; uid=rB8LJ2OMN5ZJsVvM5zsZAg==; __cfruid=d0c971b16998c6f2f5b9839a7255a311872aeed0-1670153015; lang=id; vueSymbol=sandusdt; lastLoginAccount=ramdanriawan3@gmail.com; mytoken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g; isMarketMaker=200301; userType=1%\"2C1;';
        $headers[] = 'Sec-Fetch-Dest: empty';
        $headers[] = 'Sec-Fetch-Mode: cors';
        $headers[] = 'Sec-Fetch-Site: same-origin';
        $headers[] = 'Te: trailers';
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        $result = curl_exec($ch);
        if (curl_errno($ch)) {
            echo 'Error:' . curl_error($ch);
        }
        curl_close($ch);

        $this->sendTelegramMessage2("Berhasil set bep untuk id: " . $order_id);
    }

    public function addPosition($order_no, $price, $leverage, $margin, $order_type, $take_profit_rate, $stop_loss_rate, $coin_id, $token_bearer)
    {

        $file_name = "has_add_" . $order_no;

        if (file_exists($file_name)) {
            return;
        }

        try {
            // untuk membuka posisi
            // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
            $ch = curl_init();

            curl_setopt($ch, CURLOPT_URL, 'https://www.moonxbt.com/cfd/app/pending/create');
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_POSTFIELDS, "token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g&type=1&symbol=sandusdt&leverage=$leverage&startBond=$margin&openPrice=$price&direction=$order_type&targetProfitRatio=$take_profit_rate&stopLossRatio=$stop_loss_rate&deviceType=Web");

            $headers = array();
            $headers[] = 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0';
            $headers[] = 'Accept: application/json, text/plain, */*';
            $headers[] = 'Accept-Language: id';
            $headers[] = 'Content-Type: application/x-www-form-urlencoded';
            $headers[] = 'Origin: https://www.moonxbt.com';
            $headers[] = 'Connection: keep-alive';
            $headers[] = 'Referer: https://www.moonxbt.com/trade/SANDUSDT';
            $headers[] = 'Cookie: Hm_lvt_fbbbc9768e53aa2ef634d6949813475c=1664747580; _ga_SFLCT88EKX=GS1.1.1664771125.2.0.1664771125.0.0.0; _ga=GA1.1.1362986683.1664747594; __zlcmid=1CFlGsea16a9RUR; lang=id; uid=rB8KBGOPCr8ydSoAF6dRAg==; __cfruid=7d221e5660a75597c5c492d0298d214ae65aa422-1670354117; vueSymbol=sandusdt; lastLoginAccount=ramdanriawan3@gmail.com; mytoken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g; isMarketMaker=200301; userType=1%\"2C1;';
            $headers[] = 'Sec-Fetch-Dest: empty';
            $headers[] = 'Sec-Fetch-Mode: cors';
            $headers[] = 'Sec-Fetch-Site: same-origin';
            $headers[] = 'Te: trailers';
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

            $json = curl_exec($ch);
            if (curl_errno($ch)) {
                echo 'Error:' . curl_error($ch);
            }
            curl_close($ch);

            $result = json_decode($json);

            if ($result->code === 0) {
                $message = "posisi untuk pair $coin_id telah berhasil ditambah";
                $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=$message&lang=en-GB-Standard-B&rpt=2", [

                ]);

                file_put_contents($file_name, "-");

                $this->sendTelegramMessage2($message);
            } elseif ($result->code != 0) {
                $message = "posisi untuk pair $coin_id gagal ditambah";
                $response = $this->client()->request('GET', "https://api.callmebot.com/start.php?user=@ramdanriawan&text=$message&lang=en-GB-Standard-B&rpt=2", [

                ]);

                $this->sendTelegramMessage2($message);
            } else {

                $this->sendTelegramMessage2("Gagal menambah posisi");

                file_put_contents("gagal_tambah_posisi");
            }
        } catch (\Throwable $t) {
            $this->sendTelegramMessage2("Gagal menambah posisi");

            file_put_contents("gagal_tambah_posisi", $t->getMessage());
        }
    }

    public function getOrders()
    {
        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, 'https://www.moonxbt.com/cfd/app/status/combo');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
            'token' => 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g',
            'currency' => 'sandusdt',
            'interval' => '4',
            'periods' => "[
                '4'
            ]",
            'symbols' => "[
                'sandusdt'
            ]",
            'type' => 'Bp',
            'holdingPageNum' => 1,
            'holdingPageSize' => 40,
            'pendingPageNum' => 1,
            'pendingPageSize' => 40,
            'orderType' => -1,
            'types' => "[
                'Bp'
            ]"
        ]));

        $headers = array();
        $headers[] = 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0';
        $headers[] = 'Accept: application/json, text/plain, */*';
        $headers[] = 'Accept-Language: id';
        $headers[] = 'Content-Type: application/x-www-form-urlencoded';
        $headers[] = 'Origin: https://www.moonxbt.com';
        $headers[] = 'Connection: keep-alive';
        $headers[] = 'Referer: https://www.moonxbt.com/trade/SANDUSDT';
        $headers[] = 'Cookie: Hm_lvt_fbbbc9768e53aa2ef634d6949813475c=1664747580; _ga_SFLCT88EKX=GS1.1.1664771125.2.0.1664771125.0.0.0; _ga=GA1.1.1362986683.1664747594; __zlcmid=1CFlGsea16a9RUR; lang=id; uid=rB8KBGOPCr8ydSoAF6dRAg==; __cfruid=3d7e2c576c499a8ea3d5ec979d5e6ba2713eadc2-1670335882; vueSymbol=sandusdt; lastLoginAccount=ramdanriawan3@gmail.com; mytoken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g; isMarketMaker=200301; userType=1%\"2C1;';
        $headers[] = 'Sec-Fetch-Dest: empty';
        $headers[] = 'Sec-Fetch-Mode: cors';
        $headers[] = 'Sec-Fetch-Site: same-origin';
        $headers[] = 'Te: trailers';
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        $result = curl_exec($ch);
        if (curl_errno($ch)) {
            echo 'Error:' . curl_error($ch);
        }
        curl_close($ch);

        return json_decode($result);
    }

    public function sendTelegramMessage2($message)
    {
        $response = $this->client()->request('GET', "https://api.callmebot.com/text.php?user=@ramdanriawan&text=$message", [

        ]);

        return json_encode([
            'status' => 'success'
        ]);
    }

    public function gantiToken(Request $request)
    {
        $file_watch_js = file_get_contents("watch.js");
        $file_bot_trading = file_get_contents((__DIR__ . '/BotTradingController.php'));

        $command1 = "ps -ef | grep 'java' | grep -v grep | awk '{print $2}' | xargs -r kill -9";
        $command2 = "ps -ef | grep 'geckodriver' | grep -v grep | awk '{print $2}' | xargs -r kill -9";
        $command3 = "ps -ef | grep 'firefox' | grep -v grep | awk '{print $2}' | xargs -r kill -9";

        $token_lama = $request->token_lama;
        $token_baru = $request->token_baru;

        $file_watch_js = str_replace($token_lama, $token_baru, $file_watch_js);
        $file_bot_trading = str_replace($token_lama, $token_baru, $file_bot_trading);
        file_put_contents('watch.js', $file_watch_js);
        file_put_contents((__DIR__ . '/BotTradingController.php'), $file_bot_trading);

        //
        $host = "185.211.5.241";
        $username = "root";
        $password = "mautauajakamu98";

        $ssh = new SSH2($host);
        if (!$ssh->login($username, $password)) {
            exec("curl 'https://bikinaplikasi.dev/bot-trading/call-telegram-message?telegram_id=ramdanriawan&message=login ssh untuk ganti token gagal'");
        } else {

            $ssh->exec($command1);
            $ssh->exec($command2);
            $ssh->exec($command3);
        }

        die("https://bikinaplikasi.dev/bot-trading/ganti-token?token_lama=$token_baru&token_baru=");
    }


    public function gantiMargin(Request $request)
    {
        $file_watch_js = file_get_contents("watch.js");
        $file_bot_trading = file_get_contents((__DIR__ . '/BotTradingController.php'));

        $command1 = "ps -ef | grep 'java' | grep -v grep | awk '{print $2}' | xargs -r kill -9";
        $command2 = "ps -ef | grep 'geckodriver' | grep -v grep | awk '{print $2}' | xargs -r kill -9";
        $command3 = "ps -ef | grep 'firefox' | grep -v grep | awk '{print $2}' | xargs -r kill -9";

        $margin_lama = $request->margin_lama;
        $margin_baru = $request->margin_baru;

        $file_watch_js = str_replace($margin_lama, $margin_baru, $file_watch_js);
        $file_bot_trading = str_replace($margin_lama, $margin_baru, $file_bot_trading);
        file_put_contents('watch.js', $file_watch_js);
        file_put_contents((__DIR__ . '/BotTradingController.php'), $file_bot_trading);

        //
        $host = "185.211.5.241";
        $username = "root";
        $password = "mautauajakamu98";

        $ssh = new SSH2($host);
        if (!$ssh->login($username, $password)) {
            exec("curl 'https://bikinaplikasi.dev/bot-trading/call-telegram-message?telegram_id=ramdanriawan&message=login ssh untuk ganti token gagal'");
        } else {

            $ssh->exec($command1);
            $ssh->exec($command2);
            $ssh->exec($command3);
        }

        die("oke");
    }

    public function checkSaldo()
    {
        // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, 'https://www.moonxbt.com/account/app/capital/sum?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'GET');

        $headers = array();
        $headers[] = 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0';
        $headers[] = 'Accept: application/json, text/plain, */*';
        $headers[] = 'Accept-Language: id';
        $headers[] = 'Content-Type: application/x-www-form-urlencoded';
        $headers[] = 'Connection: keep-alive';
        $headers[] = 'Referer: https://www.moonxbt.com/asset/futures';
        $headers[] = 'Cookie: Hm_lvt_fbbbc9768e53aa2ef634d6949813475c=1664747580; _ga_SFLCT88EKX=GS1.1.1664771125.2.0.1664771125.0.0.0; _ga=GA1.1.1362986683.1664747594; __zlcmid=1CFlGsea16a9RUR; lang=id; uid=rB8KBGOPCr8ydSoAF6dRAg==; __cfruid=d61a4356561a50b0067d957cfcf64766827f2096-1670345406; vueSymbol=sandusdt; lastLoginAccount=ramdanriawan3@gmail.com; mytoken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMDU3Mzk4MSIsImV4cCI6MTY3NTgyNzQ1MiwiaWF0IjoxNjc1MjIyNjUyfQ.989lGKWgZm3zseUZKa3JSHYyY63H0JwEL_qeKhJt29g; isMarketMaker=200301; userType=1%\"2C1;';
        $headers[] = 'Sec-Fetch-Dest: empty';
        $headers[] = 'Sec-Fetch-Mode: cors';
        $headers[] = 'Sec-Fetch-Site: same-origin';
        $headers[] = 'Te: trailers';
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        $result = json_decode(curl_exec($ch));

        if (curl_errno($ch)) {
            echo 'Error:' . curl_error($ch);
        }

        curl_close($ch);

        die($result->data->sum->CONTRACT_ACCOUNT->USDT->availableBalance);
    }

    public function checkJsIsActive()
    {
        $this->sendTelegramMessage2('Watch js is active!');
    }
}